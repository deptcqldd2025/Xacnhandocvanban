<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cổng Phổ Biến Văn Bản - V1.21 Profile</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#004e9e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Văn Bản Số">
    <link rel="apple-touch-icon" href="logo_doc_ct.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Roboto', sans-serif; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        
        /* LOGIN STYLES */
        .login-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; background: #fff; }
        .login-container { width: 100%; max-width: 400px; text-align: center; }
        .evn-logo-full { width: 100%; max-width: 280px; height: auto; margin-bottom: 25px; display: block; margin-left: auto; margin-right: auto; }
        .app-title { color: #004e9e; font-weight: 700; font-size: 1.4rem; text-transform: uppercase; margin-bottom: 5px; }
        .app-subtitle { color: #6c757d; font-size: 0.95rem; margin-bottom: 30px; font-weight: 500; }
        .form-label-custom { font-weight: 700; color: #444; font-size: 0.9rem; display: block; text-align: left; margin-bottom: 8px; }
        .input-group-custom { border: 1px solid #ced4da; border-radius: 8px; overflow: hidden; background: #fff; margin-bottom: 20px; transition: 0.2s; }
        .input-group-custom:focus-within { border-color: #004e9e; box-shadow: 0 0 0 0.2rem rgba(0, 78, 158, 0.1); }
        .input-icon { border: none; color: #999; padding-left: 15px; display: flex; align-items: center; }
        .form-control-custom { border: none; box-shadow: none; padding: 12px 10px; font-size: 0.95rem; }
        .btn-login-custom { background-color: #004e9e; border: none; border-radius: 8px; color: white; font-weight: 700; text-transform: uppercase; padding: 12px; width: 100%; margin-top: 10px; }
        .btn-login-custom:hover { background-color: #003a75; }
        
        /* MAIN APP STYLES */
        .main-app { display: none; width: 100%; flex: 1; padding-top: 20px; padding-bottom: 40px; }
        .viewer-container { position: relative; height: 75vh; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #fff; }
        .doc-viewer { width: 100%; height: 100%; border: none; }
        .iframe-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .list-group-item.active { background-color: #e7f1ff; color: #000; border-color: #dee2e6; }
        .doc-read-indicator { font-size: 0.85em; font-weight: bold; color: #198754; }
        
        /* FOOTER */
        .copyright { margin-top: auto; padding: 20px; text-align: center; color: #adb5bd; font-size: 0.8rem; width: 100%; background: #fff; border-top: 1px solid #eee; }
        .main-app .copyright { background: #f0f2f5; border: none; }

        /* Admin & Table */
        .progress-thin { height: 6px; border-radius: 3px; }
        .btn-toolbar-custom .btn { border-radius: 20px; padding-left: 15px; padding-right: 15px; }
        .staff-table-container { max-height: 400px; overflow-y: auto; font-size: 0.85rem; border: 1px solid #eee; }
        .staff-table th { background: #f8f9fa; position: sticky; top: 0; }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-wrapper">
        <div class="login-container">
            <div class="mb-2">
                <img src="logo_doc_ct.png" alt="EVN Logo" class="evn-logo-full">
            </div>
            <h3 class="app-title">CỔNG PHỔ BIẾN VĂN BẢN</h3>
            <p class="app-subtitle">Hệ thống quản lý nội bộ - Đội QLLĐ 2</p>

            <div style="text-align: left;">
                <label class="form-label-custom">Email Outlook</label>
                <div class="input-group-custom d-flex">
                    <span class="input-icon"><i class="fas fa-envelope"></i></span>
                    <input type="email" id="emailInput" class="form-control form-control-custom" placeholder="Ví dụ: namqt@hcmpc.com.vn">
                </div>
                <label class="form-label-custom">Mật khẩu</label>
                <div class="input-group-custom d-flex align-items-center">
                    <span class="input-icon"><i class="fas fa-lock"></i></span>
                    <input type="password" id="passwordInput" class="form-control form-control-custom" placeholder="Nhập mật khẩu">
                    <button class="btn border-0 bg-transparent text-muted" type="button" onclick="togglePassword()">
                        <i class="fas fa-eye" id="eyeIcon"></i>
                    </button>
                </div>
            </div>
            <button onclick="handleLogin()" id="btnLogin" class="btn-login-custom">ĐĂNG NHẬP <i class="fas fa-arrow-right"></i></button>
            <div id="loginError" class="text-danger mt-3 small fw-bold"></div>
            <a href="#" class="text-muted small mt-3 d-inline-block text-decoration-none">Quên mật khẩu?</a>
        </div>
    </div>

    <div id="mainApp" class="main-app">
        <div class="container">
            <nav class="navbar navbar-light bg-white rounded shadow-sm mb-4 px-3">
                <div class="d-flex align-items-center">
                    <img src="logo_doc_ct.png" style="height: 40px; width: auto;" class="me-2">
                    <span class="fw-bold text-dark d-none d-md-block">Cổng Phổ Biến Văn Bản</span>
                    <span class="badge bg-danger ms-2" id="adminBadge" style="display:none">ADMIN</span>
                </div>
                <div class="d-flex align-items-center">
                    <button onclick="openProfileModal()" class="btn btn-sm btn-outline-primary me-2" title="Thông tin cá nhân">
                        <i class="fas fa-user-circle me-1"></i> <span class="d-none d-md-inline">Tài khoản</span>
                    </button>
                    <button onclick="handleLogout()" class="btn btn-sm btn-outline-secondary" title="Đăng xuất"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </nav>

            <div id="adminPanel" style="display:none;" class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0 fw-bold text-primary"><i class="fas fa-tasks me-2"></i>Quản trị hệ thống</h6>
                    <div class="btn-toolbar-custom">
                        <button class="btn btn-sm btn-outline-primary me-2" type="button" data-bs-toggle="collapse" data-bs-target="#staffCollapse">
                            <i class="fas fa-users-cog me-1"></i> Danh sách nhân sự
                        </button>
                        <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#uploadCollapse">
                            <i class="fas fa-plus-circle me-1"></i> Tạo văn bản mới
                        </button>
                    </div>
                </div>

                <div class="collapse mb-3" id="uploadCollapse">
                    <div class="card shadow-sm border-0">
                        <div class="card-body bg-light border-top">
                            <div class="row g-3">
                                <div class="col-md-5">
                                    <label class="form-label small fw-bold">Tên văn bản</label>
                                    <input type="text" id="docTitleInput" class="form-control" placeholder="Nhập tiêu đề...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold">File PDF</label>
                                    <input type="file" id="fileInput" class="form-control" accept="application/pdf" onchange="handleFileSelect()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small fw-bold">Số trang</label>
                                    <input type="number" id="pageCountInput" class="form-control bg-white" readonly placeholder="...">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small fw-bold">Thời gian (Giây)</label>
                                    <input type="number" id="docTimeInput" class="form-control" value="15">
                                </div>
                                <div class="col-12 text-end">
                                    <div id="statusLog" class="d-inline-block text-danger small me-2 fw-bold"></div>
                                    <button onclick="uploadDocument()" id="btnUpload" class="btn btn-success">
                                        <i class="fas fa-cloud-upload-alt me-1"></i> Phát hành ngay
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="collapse mb-3" id="staffCollapse">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <span class="fw-bold">Danh sách nhân sự</span>
                            <div>
                                <input type="file" id="staffExcelInput" accept=".xlsx, .xls, .csv" style="display: none;" onchange="handleStaffExcelUpload()">
                                <button onclick="document.getElementById('staffExcelInput').click()" class="btn btn-sm btn-outline-success me-2">
                                    <i class="fas fa-file-excel me-1"></i> Nhập từ Excel
                                </button>
                                <button onclick="saveStaffList()" class="btn btn-sm btn-primary">
                                    <i class="fas fa-save me-1"></i> Lưu lại
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="staff-table-container">
                                <table class="table table-hover table-striped mb-0 staff-table">
                                    <thead><tr><th>MSNV</th><th>Họ và tên</th><th>Đơn vị</th><th>Email</th><th>SĐT</th></tr></thead>
                                    <tbody id="staffTableBody"><tr><td colspan="5" class="text-center text-muted py-3">Chưa có dữ liệu.</td></tr></tbody>
                                </table>
                            </div>
                            <div class="p-2 text-end small text-muted bg-light">
                                Tổng số: <span id="staffCountDisplay" class="fw-bold">0</span> nhân viên
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-chart-line me-2 text-info"></i>Tiến độ đọc hiểu toàn đơn vị</span>
                        <button onclick="exportReport()" class="btn btn-sm btn-outline-success"><i class="fas fa-file-excel me-1"></i> Xuất Báo cáo</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 text-center small">
                            <thead class="table-light"><tr><th class="text-start">Văn bản</th><th>Ngày BH</th><th style="width: 30%;">Tiến độ hoàn thành</th><th>Thao tác</th></tr></thead>
                            <tbody id="adminReportBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="userPanel">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                                <span>Văn bản cần đọc</span>
                                <span class="badge bg-light text-dark border" id="readCountBadge">0/0</span>
                            </div>
                            <div class="list-group list-group-flush" id="documentList" style="max-height: 75vh; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="emptyState" class="text-center p-5 bg-white rounded shadow-sm h-100 d-flex flex-column justify-content-center align-items-center">
                            <i class="fas fa-book-reader fa-4x text-muted mb-3"></i>
                            <h5>Chưa chọn văn bản</h5>
                            <p class="text-muted">Vui lòng chọn văn bản bên trái để bắt đầu.</p>
                        </div>
                        <div id="readingView" style="display:none;">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 text-truncate" id="viewTitle" style="max-width: 65%;">Tiêu đề</h5>
                                    <span id="viewStatus" class="badge bg-secondary">Chưa đọc</span>
                                </div>
                                <div class="card-body p-0">
                                    <div class="viewer-container">
                                        <div id="iframeLoader" class="iframe-loading">
                                            <div class="spinner-border text-primary mb-2" role="status"></div>
                                            <small class="text-muted">Đang tải tài liệu...</small>
                                        </div>
                                        <iframe id="pdfViewer" class="doc-viewer" src="" onload="onIframeLoad()"></iframe>
                                    </div>
                                    <div class="p-3 bg-light border-top d-flex justify-content-between align-items-center flex-wrap gap-2">
                                        <div class="d-flex align-items-center fw-bold" id="timerContainer">
                                            <i class="fas fa-hourglass-half me-2"></i> <span id="timerText">00:00</span>
                                        </div>
                                        <button id="btnConfirmRead" onclick="confirmRead()" class="btn btn-secondary" disabled>
                                            <i class="fas fa-check-circle me-1"></i> Xác nhận đã đọc hiểu
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="copyright">
        © 2026 TCD Software - version 1.21 - Liên hệ 0963.292.882
    </div>

    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-id-card me-2"></i>Thông tin cá nhân</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="profileForm">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Họ và tên</label>
                            <input type="text" class="form-control" id="profileName" readonly style="background-color: #e9ecef;">
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label small fw-bold">MSNV</label>
                                <input type="text" class="form-control" id="profileMsnv" readonly style="background-color: #e9ecef;">
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold">Đơn vị</label>
                                <input type="text" class="form-control" id="profileUnit" readonly style="background-color: #e9ecef;">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Email (Tài khoản)</label>
                            <input type="email" class="form-control" id="profileEmail" readonly style="background-color: #e9ecef;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-primary">Số điện thoại (Có thể cập nhật)</label>
                            <input type="tel" class="form-control" id="profilePhone" placeholder="Nhập số điện thoại...">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="updateProfile()">Cập nhật</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailModalTitle">Chi tiết đọc hiểu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item"><a class="nav-link active text-success" data-bs-toggle="tab" href="#tabRead">Đã đọc (<span id="countRead">0</span>)</a></li>
                        <li class="nav-item"><a class="nav-link text-danger" data-bs-toggle="tab" href="#tabUnread">Chưa đọc (<span id="countUnread">0</span>)</a></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tabRead"><ul class="list-group" id="listRead"></ul></div>
                        <div class="tab-pane fade" id="tabUnread"><ul class="list-group" id="listUnread"></ul></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // PWA
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('service-worker.js'); }

        // CONFIG
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyqgLvaQbt1dIpQhYedIGURkPBuRZ-i-mJWe_qUBIN9mUOP7Oy0CQI9h3u6fzxfW-Xrkw/exec"; 
        const firebaseConfig = { apiKey: "AIzaSyDC2PzQxU5K3PaoPIMTW7niXeMEHDOLM8I", authDomain: "xacnhandocvanban.firebaseapp.com", projectId: "xacnhandocvanban", storageBucket: "xacnhandocvanban.firebasestorage.app", messagingSenderId: "352352957922", appId: "1:352352957922:web:6b74ae47b238bf00d335bb", measurementId: "G-G87Z9DV9R7" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // STATE
        let currentUser = null;
        let isAdmin = false;
        let staffList = [];
        let docsStats = {};
        let readsData = [];

        // LOAD STAFF LIST (Global)
        function loadStaffList() {
            db.collection('settings').doc('staff').get().then(doc => {
                if (doc.exists && doc.data().list) {
                    staffList = doc.data().list;
                    if(isAdmin) {
                        document.getElementById('staffListInput').value = staffList.map(s => s.email).join('\n'); // Raw view not fully used but ok
                        renderStaffTable(staffList);
                        loadAdminStats();
                    }
                }
            });
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                const email = user.email.toLowerCase();
                isAdmin = (email.includes('deprc') || email.includes('deptc') || email.includes('admin'));
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('userEmailDisplay').innerText = user.email;
                
                loadStaffList(); // Fetch staff info for everyone
                if (isAdmin) setupAdminView(); else setupUserView();
                listenForNewDocs();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        // --- PROFILE FUNCTIONS ---
        function openProfileModal() {
            if (!currentUser) return;
            // Find staff info by email
            const myInfo = staffList.find(s => s.email && s.email.toLowerCase() === currentUser.email.toLowerCase());
            
            document.getElementById('profileEmail').value = currentUser.email;
            if (myInfo) {
                document.getElementById('profileName').value = myInfo.name || '';
                document.getElementById('profileMsnv').value = myInfo.msnv || '';
                document.getElementById('profileUnit').value = myInfo.unit || '';
                document.getElementById('profilePhone').value = myInfo.phone || '';
            } else {
                document.getElementById('profileName').value = "Chưa có thông tin";
                document.getElementById('profileMsnv').value = "";
                document.getElementById('profileUnit').value = "";
                document.getElementById('profilePhone').value = "";
            }
            new bootstrap.Modal(document.getElementById('profileModal')).show();
        }

        function updateProfile() {
            if (!currentUser) return;
            const newPhone = document.getElementById('profilePhone').value;
            const userIndex = staffList.findIndex(s => s.email && s.email.toLowerCase() === currentUser.email.toLowerCase());

            if (userIndex === -1) {
                alert("Bạn chưa có tên trong danh sách nhân sự. Vui lòng liên hệ Admin thêm vào.");
                return;
            }

            // Update local state
            staffList[userIndex].phone = newPhone;

            // Save to DB
            db.collection('settings').doc('staff').set({ list: staffList })
                .then(() => {
                    alert("Cập nhật thông tin thành công!");
                    bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
                })
                .catch(err => alert("Lỗi cập nhật: " + err.message));
        }

        // --- ADMIN: EXCEL & STAFF ---
        function setupAdminView() {
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('userPanel').style.display = 'none'; 
            document.getElementById('adminBadge').style.display = 'inline-block';
        }

        function handleStaffExcelUpload() {
            const file = document.getElementById('staffExcelInput').files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                const header = json[0].map(h => String(h).trim().toLowerCase());
                
                const idxMSNV = header.findIndex(h => h.includes('msnv'));
                const idxUnit = header.findIndex(h => h.includes('đơn vị'));
                const idxName = header.findIndex(h => h.includes('họ và tên') || h.includes('họ tên'));
                const idxEmail = header.findIndex(h => h.includes('email'));
                const idxPhone = header.findIndex(h => h.includes('đtdđ') || h.includes('điện thoại'));

                if(idxMSNV === -1 || idxName === -1) return alert("File Excel thiếu cột MSNV hoặc Họ tên!");

                const newStaffList = [];
                for(let i=1; i<json.length; i++) {
                    const row = json[i];
                    if(!row[idxMSNV] || !row[idxName]) continue;
                    newStaffList.push({
                        msnv: row[idxMSNV], name: row[idxName],
                        unit: row[idxUnit] || '',
                        email: row[idxEmail] ? String(row[idxEmail]).trim().toLowerCase() : '',
                        phone: row[idxPhone] || ''
                    });
                }
                staffList = newStaffList;
                renderStaffTable(staffList);
                alert(`Đã đọc ${newStaffList.length} nhân viên. Hãy bấm "Lưu lại".`);
            };
            reader.readAsArrayBuffer(file);
        }

        function renderStaffTable(list) {
            const tbody = document.getElementById('staffTableBody');
            tbody.innerHTML = '';
            document.getElementById('staffCountDisplay').innerText = list.length;
            list.forEach(s => tbody.innerHTML += `<tr><td>${s.msnv}</td><td>${s.name}</td><td>${s.unit}</td><td>${s.email}</td><td>${s.phone}</td></tr>`);
        }

        function saveStaffList() {
            db.collection('settings').doc('staff').set({ list: staffList }).then(() => {
                new bootstrap.Collapse(document.getElementById('staffCollapse'), { toggle: true }).hide();
                alert("Lưu thành công!"); loadAdminStats();
            });
        }

        // --- ADMIN: STATS ---
        function loadAdminStats() {
            db.collection('reads').onSnapshot(snapshot => {
                readsData = []; snapshot.forEach(doc => readsData.push(doc.data())); renderAdminTable();
            });
            db.collection('documents').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                docsStats = {}; snapshot.forEach(doc => docsStats[doc.id] = { ...doc.data(), id: doc.id }); renderAdminTable();
            });
        }

        function renderAdminTable() {
            const tbody = document.getElementById('adminReportBody');
            tbody.innerHTML = '';
            const totalStaff = staffList.length || 1; 
            Object.values(docsStats).forEach(doc => {
                const readers = new Set(readsData.filter(r => r.docId === doc.id).map(r => r.userEmail));
                let count = 0; staffList.forEach(s => { if (s.email && readers.has(s.email)) count++; });
                const percent = Math.round((count / totalStaff) * 100);
                const date = doc.createdAt ? doc.createdAt.toDate().toLocaleDateString('vi-VN') : '';
                tbody.innerHTML += `<tr><td class="text-start text-truncate" style="max-width: 250px;">${doc.title}</td><td>${date}</td><td><div class="progress progress-thin mb-1"><div class="progress-bar bg-success" style="width: ${percent}%"></div></div><span class="small fw-bold text-muted">${count}/${totalStaff} (${percent}%)</span></td><td><button class="btn btn-sm btn-outline-primary" onclick="showDetail('${doc.id}')"><i class="fas fa-info-circle"></i></button></td></tr>`;
            });
        }

        function showDetail(docId) {
            const doc = docsStats[docId];
            const readers = new Set(readsData.filter(r => r.docId === docId).map(r => r.userEmail));
            const readListObj = staffList.filter(s => s.email && readers.has(s.email));
            const unreadListObj = staffList.filter(s => !s.email || !readers.has(s.email));
            
            document.getElementById('detailModalTitle').innerText = doc.title;
            document.getElementById('countRead').innerText = readListObj.length;
            document.getElementById('countUnread').innerText = unreadListObj.length;
            
            document.getElementById('listRead').innerHTML = readListObj.length ? readListObj.map(s => `<li class="list-group-item small"><i class="fas fa-check text-success me-2"></i><b>${s.name}</b> (${s.unit})</li>`).join('') : '<li class="list-group-item text-muted">Trống</li>';
            document.getElementById('listUnread').innerHTML = unreadListObj.length ? unreadListObj.map(s => `<li class="list-group-item small"><i class="fas fa-times text-danger me-2"></i><b>${s.name}</b> ${!s.email?'(Thiếu Email)':''}</li>`).join('') : '<li class="list-group-item text-muted">Đã đọc hết</li>';
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        function exportReport() {
            const now = new Date();
            const fileName = `xacnhandocvb_${String(now.getDate()).padStart(2,'0')}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getFullYear()).slice(2)}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.xlsx`;
            const data = [];
            Object.values(docsStats).forEach(doc => {
                const readers = new Set(readsData.filter(r => r.docId === doc.id).map(r => r.userEmail));
                staffList.forEach(s => {
                    data.push({ "Tên văn bản": doc.title, "Ngày ban hành": doc.createdAt ? doc.createdAt.toDate().toLocaleDateString('vi-VN') : '', "MSNV": s.msnv, "Họ và tên": s.name, "Đơn vị": s.unit, "Email": s.email, "Trạng thái": (s.email && readers.has(s.email)) ? "Đã đọc" : "Chưa đọc" });
                });
            });
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Báo cáo"); XLSX.writeFile(wb, fileName);
        }

        // --- UPLOAD ---
        async function handleFileSelect() {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try { const pdf = await pdfjsLib.getDocument(new Uint8Array(e.target.result)).promise;
                        document.getElementById('pageCountInput').value = pdf.numPages;
                        document.getElementById('docTimeInput').value = pdf.numPages * 15;
                    } catch (e) { document.getElementById('pageCountInput').value = ""; }
                }; reader.readAsArrayBuffer(file);
            }
        }

        const getBase64 = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = error => reject(error); });

        async function uploadDocument() {
            const title = document.getElementById('docTitleInput').value;
            const minTime = parseInt(document.getElementById('docTimeInput').value);
            const file = document.getElementById('fileInput').files[0];
            const btn = document.getElementById('btnUpload');
            const statusLog = document.getElementById('statusLog');
            if (!title || !file) return alert("Thiếu thông tin!");
            btn.disabled = true; statusLog.innerText = "Đang xử lý...";
            try {
                const base64Data = await getBase64(file);
                statusLog.innerText = "Đang Upload Drive...";
                const response = await fetch(GAS_WEB_APP_URL, { method: 'POST', redirect: 'follow', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ filename: file.name, mimeType: file.type, data: base64Data }) });
                if (!response.ok) throw new Error("Lỗi mạng");
                const result = await response.json();
                if(result.status !== 'success') throw new Error(result.message);
                statusLog.innerText = "Lưu DB...";
                await db.collection('documents').add({ title: title, url: result.url, originalUrl: result.originalUrl, minTime: minTime, createdAt: firebase.firestore.FieldValue.serverTimestamp(), createdBy: currentUser.email });
                alert("Phát hành thành công!");
                document.getElementById('docTitleInput').value = ''; document.getElementById('fileInput').value = ''; document.getElementById('pageCountInput').value = '';
                new bootstrap.Collapse(document.getElementById('uploadCollapse'), { toggle: true }).hide();
                btn.disabled = false; statusLog.innerText = "";
            } catch (error) { statusLog.innerText = "Lỗi: " + error.message; btn.disabled = false; }
        }

        // --- USER UI ---
        function setupUserView() {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('userPanel').style.display = 'block';
            db.collection('documents').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                allDocsData = []; snapshot.forEach(doc => allDocsData.push({ id: doc.id, ...doc.data() })); renderUserDocList();
            });
            db.collection('reads').where('userId', '==', currentUser.uid).onSnapshot(snapshot => {
                userReadIds = new Set(); snapshot.forEach(doc => userReadIds.add(doc.data().docId)); renderUserDocList();
            });
        }
        
        let allDocsData = [], userReadIds = new Set(), currentDoc = null, readTimer = null, timeLeft = 0;
        
        function renderUserDocList() {
            const listEl = document.getElementById('documentList');
            const badgeEl = document.getElementById('readCountBadge');
            let readCount = 0; listEl.innerHTML = '';
            allDocsData.forEach(doc => {
                const isRead = userReadIds.has(doc.id); if (isRead) readCount++;
                const activeClass = (currentDoc && currentDoc.id === doc.id) ? 'active' : '';
                const statusHtml = isRead ? `<span class="doc-read-indicator"><i class="fas fa-check-circle"></i> Đã đọc</span>` : `<span class="text-danger small fw-bold">Chưa đọc</span>`;
                const el = document.createElement('button'); el.className = `list-group-item list-group-item-action py-3 ${activeClass}`;
                el.innerHTML = `<div class="d-flex w-100 justify-content-between mb-1"><h6 class="mb-0 fw-bold text-truncate" style="max-width: 70%;">${doc.title}</h6></div><div class="d-flex justify-content-between"><small class="text-muted">${doc.minTime}s</small>${statusHtml}</div>`;
                el.onclick = () => openDocument(doc); listEl.appendChild(el);
            });
            badgeEl.innerText = `${readCount}/${allDocsData.length}`;
        }

        function openDocument(data) {
            document.getElementById('emptyState').style.setProperty('display', 'none', 'important');
            document.getElementById('readingView').style.display = 'block';
            currentDoc = data; renderUserDocList();
            document.getElementById('viewTitle').innerText = data.title;
            const iframe = document.getElementById('pdfViewer');
            document.getElementById('iframeLoader').style.display = 'flex'; iframe.style.opacity = '0'; iframe.src = data.url;
            setTimeout(() => { document.getElementById('iframeLoader').style.display = 'none'; iframe.style.opacity = '1'; }, 4000);
            clearInterval(readTimer); timeLeft = data.minTime;
            const btn = document.getElementById('btnConfirmRead'); const timerText = document.getElementById('timerText');
            if (userReadIds.has(data.id)) { btn.className = 'btn btn-success disabled'; btn.innerHTML = '<i class="fas fa-check"></i> Đã hoàn thành'; btn.disabled = true; timerText.innerText = "Hoàn tất"; }
            else { btn.className = 'btn btn-secondary'; btn.innerHTML = 'Đang đọc...'; btn.disabled = true; timerText.innerText = timeLeft + "s"; readTimer = setInterval(() => { timeLeft--; timerText.innerText = timeLeft + "s"; if (timeLeft <= 0) { clearInterval(readTimer); btn.disabled = false; btn.className = 'btn btn-primary'; btn.innerHTML = 'Xác nhận đã đọc hiểu'; } }, 1000); }
        }
        function onIframeLoad() { setTimeout(() => { document.getElementById('iframeLoader').style.display = 'none'; document.getElementById('pdfViewer').style.opacity = '1'; }, 500); }
        
        async function confirmRead() {
            if (!currentUser || !currentDoc) return;
            document.getElementById('btnConfirmRead').disabled = true;
            await db.collection('reads').add({ userId: currentUser.uid, userEmail: currentUser.email, docId: currentDoc.id, docTitle: currentDoc.title, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        }

        async function handleLogin() {
            const email = document.getElementById('emailInput').value; const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError'); if (!email || !password) return errorDiv.innerText = "Vui lòng nhập đủ thông tin";
            try { await auth.signInWithEmailAndPassword(email, password); } catch (error) { if (error.code.includes('user-not-found') || error.code.includes('invalid')) { try { await auth.createUserWithEmailAndPassword(email, password); } catch (err) { errorDiv.innerText = "Lỗi đăng nhập/tạo mới: " + err.message; } } else errorDiv.innerText = "Lỗi: " + error.message; }
        }
        function togglePassword() { const input = document.getElementById('passwordInput'); const icon = document.getElementById('eyeIcon'); if (input.type === "password") { input.type = "text"; icon.className = "fas fa-eye-slash"; } else { input.type = "password"; icon.className = "fas fa-eye"; } }
        function handleLogout() { auth.signOut(); location.reload(); }
        function listenForNewDocs() {
            let isFirst = true; db.collection('documents').orderBy('createdAt', 'desc').limit(1).onSnapshot(snapshot => { if (isFirst) { isFirst = false; return; } if (!snapshot.empty && snapshot.docs[0].data().createdBy !== currentUser.email && Notification.permission === "granted") new Notification("Văn bản mới!", { body: snapshot.docs[0].data().title }); });
        }
    </script>
</body>
</html>
