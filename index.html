<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cổng Văn Bản Số - V1.11 Fix UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .login-wrapper { height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 100%; max-width: 400px; padding: 2rem; border-radius: 15px; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .main-app { display: none; padding-top: 20px; padding-bottom: 60px; }
        
        /* Viewer Styles */
        .viewer-container { position: relative; height: 75vh; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #fff; }
        .doc-viewer { width: 100%; height: 100%; border: none; }
        
        /* Loading Overlay for Iframe */
        .iframe-loading {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #f8f9fa; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 10;
        }

        /* List Item Styles */
        .list-group-item.active { background-color: #e7f1ff; color: #000; border-color: #dee2e6; }
        .doc-read-indicator { font-size: 0.85em; font-weight: bold; color: #198754; }
        
        @media (max-width: 768px) { .viewer-container { height: 60vh; } }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-wrapper">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fab fa-google-drive fa-3x text-success mb-2"></i>
                <h4 class="fw-bold text-dark">Hệ thống V1.11</h4>
                <p class="text-muted small">Cập nhật giao diện & Trạng thái</p>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Email</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                    <input type="email" id="emailInput" class="form-control" placeholder="deptc@hcmpc.com.vn">
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Mật khẩu</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                    <input type="password" id="passwordInput" class="form-control" placeholder="Mật khẩu">
                </div>
            </div>
            <button onclick="handleLogin()" id="btnLogin" class="btn btn-primary w-100 py-2 fw-bold">ĐĂNG NHẬP</button>
            <div id="loginError" class="text-danger text-center mt-3 small fw-bold"></div>
        </div>
    </div>

    <div id="mainApp" class="container main-app">
        <nav class="navbar navbar-light bg-white rounded shadow-sm mb-4 px-3">
            <div class="d-flex align-items-center">
                <i class="fas fa-book-reader text-primary me-2 fa-lg"></i>
                <span class="fw-bold text-dark">Trang chủ</span>
                <span class="badge bg-danger ms-2" id="adminBadge" style="display:none">QUẢN TRỊ VIÊN</span>
            </div>
            <div class="d-flex align-items-center">
                <small class="text-muted me-2 d-none d-md-block" id="userEmailDisplay"></small>
                <button onclick="handleLogout()" class="btn btn-sm btn-outline-secondary" title="Đăng xuất"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </nav>

        <div id="adminPanel" style="display:none;" class="mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fab fa-google-drive me-2"></i>Upload văn bản mới</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tên văn bản</label>
                            <input type="text" id="docTitleInput" class="form-control" placeholder="Ví dụ: Quy định An toàn điện 2026">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Thời gian đọc (giây)</label>
                            <input type="number" id="docTimeInput" class="form-control" value="15" min="5">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">File PDF</label>
                            <input type="file" id="fileInput" class="form-control" accept="application/pdf">
                        </div>
                        <div class="col-12 text-end">
                            <button onclick="uploadDocument()" id="btnUpload" class="btn btn-success px-4">
                                <i class="fas fa-cloud-upload-alt"></i> Upload & Phát hành
                            </button>
                        </div>
                    </div>
                    <div id="statusLog" class="mt-2 text-primary fw-bold small"></div>
                </div>
            </div>
            
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-white fw-bold">Theo dõi tiến độ đọc hiểu</div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Thời gian</th>
                                    <th>Nhân viên</th>
                                    <th>Văn bản</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody id="adminReportBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="userPanel">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                            <span>Danh sách văn bản</span>
                            <span class="badge bg-light text-dark border" id="readCountBadge">0/0</span>
                        </div>
                        <div class="list-group list-group-flush" id="documentList" style="max-height: 75vh; overflow-y: auto;">
                            <div class="text-center p-3 text-muted"><span class="spinner-border spinner-border-sm"></span> Đang tải...</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div id="emptyState" class="text-center p-5 bg-white rounded shadow-sm h-100 d-flex flex-column justify-content-center align-items-center">
                        <i class="fas fa-book-reader fa-4x text-muted mb-3"></i>
                        <h5>Chưa chọn văn bản</h5>
                        <p class="text-muted">Vui lòng chọn văn bản bên trái để bắt đầu.</p>
                    </div>

                    <div id="readingView" style="display:none;">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 text-truncate" id="viewTitle" style="max-width: 65%;">Tiêu đề</h5>
                                <span id="viewStatus" class="badge bg-secondary">Chưa đọc</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="viewer-container">
                                    <div id="iframeLoader" class="iframe-loading">
                                        <div class="spinner-border text-primary mb-2" role="status"></div>
                                        <small class="text-muted">Đang tải tài liệu từ Google Drive...</small>
                                    </div>
                                    <iframe id="pdfViewer" class="doc-viewer" src="" onload="onIframeLoad()"></iframe>
                                </div>

                                <div class="p-3 bg-light border-top d-flex justify-content-between align-items-center flex-wrap gap-2">
                                    <div class="d-flex align-items-center fw-bold" id="timerContainer">
                                        <i class="fas fa-hourglass-half me-2"></i> <span id="timerText">00:00</span>
                                    </div>
                                    <button id="btnConfirmRead" onclick="confirmRead()" class="btn btn-secondary" disabled>
                                        <i class="fas fa-check-circle me-1"></i> Xác nhận đã đọc hiểu
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // --- CONFIGURATION ---
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyqgLvaQbt1dIpQhYedIGURkPBuRZ-i-mJWe_qUBIN9mUOP7Oy0CQI9h3u6fzxfW-Xrkw/exec"; 
        
        const firebaseConfig = {
            apiKey: "AIzaSyDC2PzQxU5K3PaoPIMTW7niXeMEHDOLM8I",
            authDomain: "xacnhandocvanban.firebaseapp.com",
            projectId: "xacnhandocvanban",
            storageBucket: "xacnhandocvanban.firebasestorage.app",
            messagingSenderId: "352352957922",
            appId: "1:352352957922:web:6b74ae47b238bf00d335bb",
            measurementId: "G-G87Z9DV9R7"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // STATE
        let currentUser = null;
        let isAdmin = false;
        let currentDoc = null;
        let readTimer = null;
        let timeLeft = 0;
        
        // Data Sync State (Fix lỗi danh sách)
        let allDocsData = []; // Lưu trữ tất cả văn bản
        let userReadIds = new Set(); // Lưu trữ các ID văn bản user đã đọc

        // AUTH STATE
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                const email = user.email.toLowerCase();
                isAdmin = (email.includes('deprc') || email.includes('deptc') || email.includes('admin'));
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('userEmailDisplay').innerText = user.email;
                
                if (isAdmin) setupAdminView();
                else setupUserView();
                
                listenForNewDocs();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        async function handleLogin() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');
            const btn = document.getElementById('btnLogin');

            if (!email || !password) return errorDiv.innerText = "Vui lòng nhập đủ thông tin";
            btn.disabled = true;
            btn.innerHTML = 'Đang xử lý...';
            errorDiv.innerText = "";

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                if (error.code === 'auth/invalid-login-credentials' || error.message.includes('INVALID_LOGIN_CREDENTIALS') || error.code === 'auth/user-not-found') {
                    try {
                        await auth.createUserWithEmailAndPassword(email, password);
                    } catch (createErr) {
                        errorDiv.innerText = createErr.code === 'auth/email-already-in-use' ? "Sai mật khẩu!" : "Lỗi: " + createErr.message;
                        btn.disabled = false;
                        btn.innerText = "ĐĂNG NHẬP";
                    }
                } else {
                    errorDiv.innerText = "Lỗi: " + error.message;
                    btn.disabled = false;
                    btn.innerText = "ĐĂNG NHẬP";
                }
            }
        }

        function handleLogout() {
            auth.signOut();
            location.reload();
        }

        // --- ADMIN FUNCTIONS ---
        function setupAdminView() {
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('userPanel').style.display = 'none'; 
            document.getElementById('adminBadge').style.display = 'inline-block';
            loadAdminReport();
        }

        const getBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]); 
            reader.onerror = error => reject(error);
        });

        async function uploadDocument() {
            const title = document.getElementById('docTitleInput').value;
            const minTime = parseInt(document.getElementById('docTimeInput').value);
            const file = document.getElementById('fileInput').files[0];
            const btn = document.getElementById('btnUpload');
            const statusLog = document.getElementById('statusLog');

            if (!title || !file) return alert("Vui lòng nhập tên và chọn file PDF!");

            btn.disabled = true;
            statusLog.innerText = "Đang xử lý file...";

            try {
                const base64Data = await getBase64(file);
                statusLog.innerText = "Đang gửi sang Drive... (Vui lòng đợi)";
                
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        filename: file.name,
                        mimeType: file.type,
                        data: base64Data
                    })
                });
                
                if (!response.ok) throw new Error("Lỗi kết nối: " + response.status);
                const result = await response.json();
                if(result.status !== 'success') throw new Error(result.message);

                statusLog.innerText = "Upload xong. Đang lưu DB...";
                await db.collection('documents').add({
                    title: title,
                    url: result.url,
                    originalUrl: result.originalUrl,
                    minTime: minTime,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.email,
                    storageType: 'google_drive'
                });

                statusLog.innerText = "Thành công!";
                alert("Đã phát hành văn bản!");
                document.getElementById('docTitleInput').value = '';
                document.getElementById('fileInput').value = '';
                btn.disabled = false;
                statusLog.innerText = "";
            } catch (error) {
                console.error(error);
                statusLog.innerText = "Lỗi: " + error.message;
                alert("Lỗi: " + error.message);
                btn.disabled = false;
            }
        }

        function loadAdminReport() {
            db.collection('reads').orderBy('timestamp', 'desc').limit(50).onSnapshot(snapshot => {
                const tbody = document.getElementById('adminReportBody');
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const time = data.timestamp ? data.timestamp.toDate().toLocaleString('vi-VN') : '';
                    tbody.innerHTML += `<tr><td>${time}</td><td><strong>${data.userEmail}</strong></td><td>${data.docTitle}</td><td><span class="badge bg-success">Đã ký</span></td></tr>`;
                });
            });
        }

        // --- USER FUNCTIONS (SYNC LOGIC CẢI TIẾN) ---
        function setupUserView() {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('userPanel').style.display = 'block';
            
            // 1. Lắng nghe danh sách Documents
            db.collection('documents').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                allDocsData = [];
                snapshot.forEach(doc => {
                    allDocsData.push({ id: doc.id, ...doc.data() });
                });
                renderDocumentList();
            });

            // 2. Lắng nghe trạng thái Reads của User hiện tại (Real-time)
            db.collection('reads').where('userId', '==', currentUser.uid).onSnapshot(snapshot => {
                userReadIds = new Set();
                snapshot.forEach(doc => {
                    userReadIds.add(doc.data().docId);
                });
                renderDocumentList(); // Vẽ lại list mỗi khi user đọc xong 1 bài
            });
        }

        function renderDocumentList() {
            const listEl = document.getElementById('documentList');
            const badgeEl = document.getElementById('readCountBadge');
            listEl.innerHTML = '';
            
            if (allDocsData.length === 0) {
                listEl.innerHTML = '<div class="text-center p-3">Chưa có văn bản.</div>';
                return;
            }

            let readCount = 0;

            allDocsData.forEach(doc => {
                const isRead = userReadIds.has(doc.id);
                if (isRead) readCount++;
                const activeClass = (currentDoc && currentDoc.id === doc.id) ? 'active' : '';
                
                const el = document.createElement('button');
                el.className = `list-group-item list-group-item-action py-3 ${activeClass}`;
                
                // Nội dung Item trong danh sách
                let statusHtml = isRead 
                    ? `<span class="doc-read-indicator"><i class="fas fa-check-circle"></i> Đã đọc</span>`
                    : `<span class="text-danger small"><i class="fas fa-exclamation-circle"></i> Chưa đọc</span>`;

                el.innerHTML = `
                    <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                        <h6 class="mb-0 fw-bold text-truncate" style="max-width: 70%;">${doc.title}</h6>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="${isRead ? '' : 'text-muted'}"><i class="far fa-clock"></i> ${doc.minTime}s</small>
                        ${statusHtml}
                    </div>
                `;
                el.onclick = () => openDocument(doc);
                listEl.appendChild(el);
            });
            
            badgeEl.innerText = `${readCount}/${allDocsData.length} Đã đọc`;
        }

        function openDocument(data) {
            currentDoc = data;
            renderDocumentList(); // Cập nhật class active
            
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('readingView').style.display = 'block';
            document.getElementById('viewTitle').innerText = data.title;
            
            // --- FIX LỖI BLANK PAGE: HIỆN LOADER TRƯỚC ---
            const iframe = document.getElementById('pdfViewer');
            const loader = document.getElementById('iframeLoader');
            
            loader.style.display = 'flex'; // Hiện loading
            iframe.style.opacity = '0'; // Ẩn iframe tạm thời
            iframe.src = data.url; 
            
            // Reset logic timer
            clearInterval(readTimer);
            timeLeft = data.minTime;
            const btn = document.getElementById('btnConfirmRead');
            const timerText = document.getElementById('timerText');
            const timerContainer = document.getElementById('timerContainer');
            const statusBadge = document.getElementById('viewStatus');
            
            const isRead = userReadIds.has(data.id);

            if (isRead) {
                statusBadge.className = 'badge bg-success';
                statusBadge.innerText = 'Đã hoàn thành';
                btn.className = 'btn btn-success disabled';
                btn.innerHTML = '<i class="fas fa-check"></i> Đã ký xác nhận';
                btn.disabled = true;
                timerText.innerText = "Hoàn tất";
                timerContainer.className = "d-flex align-items-center text-success fw-bold";
            } else {
                statusBadge.className = 'badge bg-warning text-dark';
                statusBadge.innerText = 'Chưa đọc';
                btn.className = 'btn btn-secondary';
                btn.innerHTML = `Đang đọc...`;
                btn.disabled = true;
                timerContainer.className = "d-flex align-items-center text-danger fw-bold";
                timerText.innerText = timeLeft + "s";
                
                readTimer = setInterval(() => {
                    timeLeft--;
                    timerText.innerText = timeLeft + "s";
                    if (timeLeft <= 0) {
                        clearInterval(readTimer);
                        btn.disabled = false;
                        btn.className = 'btn btn-primary';
                        btn.innerHTML = 'Xác nhận đã đọc hiểu';
                        timerContainer.className = "text-success fw-bold";
                        timerText.innerText = "Đủ thời gian";
                    }
                }, 1000);
            }
        }

        // --- XỬ LÝ SỰ KIỆN KHI IFRAME TẢI XONG ---
        function onIframeLoad() {
            // Khi iframe báo đã load, ẩn loader và hiện iframe
            // Thêm delay nhỏ 0.5s để chắc chắn nội dung đã render
            setTimeout(() => {
                document.getElementById('iframeLoader').style.display = 'none';
                document.getElementById('pdfViewer').style.opacity = '1';
            }, 500);
        }

        async function confirmRead() {
            if (!currentUser || !currentDoc) return;
            const btn = document.getElementById('btnConfirmRead');
            btn.disabled = true;
            try {
                await db.collection('reads').add({
                    userId: currentUser.uid, userEmail: currentUser.email,
                    docId: currentDoc.id, docTitle: currentDoc.title,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // UI cập nhật ngay lập tức nhờ Listener ở trên
                document.getElementById('viewStatus').className = 'badge bg-success';
                document.getElementById('viewStatus').innerText = 'Đã hoàn thành';
                btn.className = 'btn btn-success';
                btn.innerHTML = '<i class="fas fa-check"></i> Đã xác nhận';
            } catch (error) {
                alert("Lỗi: " + error.message);
                btn.disabled = false;
            }
        }

        // NOTIFICATION
        let isFirstLoad = true;
        function listenForNewDocs() {
            db.collection('documents').orderBy('createdAt', 'desc').limit(1).onSnapshot(snapshot => {
                if (isFirstLoad) { isFirstLoad = false; return; }
                if (!snapshot.empty) {
                    const data = snapshot.docs[0].data();
                    if (data.createdBy !== currentUser.email) {
                        if (Notification.permission === "granted") new Notification("Văn bản mới!", { body: data.title });
                    }
                }
            });
        }
    </script>
</body>
</html>
